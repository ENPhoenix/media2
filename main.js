(()=>{"use strict";function t(){return new Promise((t=>{const e=document.getElementById("coordsModal"),i=document.getElementById("coordsInput"),n=document.getElementById("coordsOk"),o=document.getElementById("coordsCancel");let s=!1;const r=()=>{e.classList.remove("active"),i.value="",n.removeEventListener("click",a),o.removeEventListener("click",d)},a=()=>{if(!s)try{const e=function(t){if(!t||"string"!=typeof t)throw new Error("Invalid input: expected string");let e=t.trim();e.startsWith("[")&&e.endsWith("]")&&(e=e.slice(1,-1).trim()),e=e.replace(/\u2212/g,"-");const i=e.split(",");if(2!==i.length)throw new Error("Invalid format: expected two coordinates separated by comma");const n=parseFloat(i[0].trim()),o=parseFloat(i[1].trim());if(isNaN(n)||isNaN(o))throw new Error("Invalid format: coordinates must be numbers");if(n<-90||n>90)throw new Error("Invalid latitude: must be between -90 and 90");if(o<-180||o>180)throw new Error("Invalid longitude: must be between -180 and 180");return{latitude:n,longitude:o}}(i.value);s=!0,r(),t(e)}catch(t){i.style.borderColor="red",setTimeout((()=>{i.style.borderColor=""}),2e3)}},d=()=>{s||(s=!0,r(),t(null))};n.addEventListener("click",a),o.addEventListener("click",d),i.addEventListener("keypress",(t=>{"Enter"===t.key&&a()})),e.classList.add("active"),i.focus()}))}async function e(){try{return await new Promise(((t,e)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{t({latitude:e.coords.latitude,longitude:e.coords.longitude})}),(t=>{e(t)}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):e(new Error("Geolocation is not supported"))}))}catch(e){return await t()}}const i=new class{constructor(t){this.container=document.getElementById(t),this.posts=[]}addTextPost(t,e){const i={id:Date.now(),type:"text",content:t,coords:e,timestamp:new Date};this.posts.unshift(i),this.renderPost(i)}addAudioPost(t,e){const i={id:Date.now(),type:"audio",content:t,coords:e,timestamp:new Date};this.posts.unshift(i),this.renderPost(i)}renderPost(t){const e=document.createElement("div");e.className="post",e.dataset.id=t.id;let i="";"text"===t.type?i=`<div class="post-content">${this.escapeHtml(t.content)}</div>`:"audio"===t.type&&(i=`\n        <div class="post-content">\n          <audio controls src="${t.content}"></audio>\n        </div>\n      `);const n=`\n      <div class="post-coords">\n        ${o=t.coords.latitude,s=t.coords.longitude,`[${o.toFixed(5)}, ${s.toFixed(5)}]`}\n      </div>\n    `;var o,s;e.innerHTML=i+n,this.container.insertBefore(e,this.container.firstChild)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}clear(){this.posts=[],this.container.innerHTML=""}}("timeline"),n=document.getElementById("textInput"),o=document.getElementById("audioBtn"),s=(document.getElementById("coordsModal"),document.getElementById("audioModal")),r=document.getElementById("audioTimer"),a=document.getElementById("audioOk"),d=document.getElementById("audioCancel"),c=new class{constructor(){this.mediaRecorder=null,this.audioChunks=[],this.stream=null,this.startTime=null,this.timerInterval=null,this.onTimerUpdate=null,this.onRecordingComplete=null,this.onError=null}async start(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.mediaRecorder=new MediaRecorder(this.stream),this.audioChunks=[],this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.audioChunks.push(t.data)},this.mediaRecorder.onstop=()=>{const t=new Blob(this.audioChunks,{type:"audio/webm"}),e=URL.createObjectURL(t);this.onRecordingComplete&&this.onRecordingComplete(e,t),this.cleanup()},this.mediaRecorder.start(),this.startTime=Date.now(),this.timerInterval=setInterval((()=>{const t=Math.floor((Date.now()-this.startTime)/1e3);this.onTimerUpdate&&this.onTimerUpdate(this.formatTime(t))}),1e3)}catch(t){throw this.onError&&this.onError(t),t}}stop(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&this.mediaRecorder.stop(),this.cleanup()}cancel(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&this.mediaRecorder.stop(),this.audioChunks=[],this.cleanup()}cleanup(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.stream&&(this.stream.getTracks().forEach((t=>t.stop())),this.stream=null)}formatTime(t){return`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`}};n.addEventListener("keypress",(async t=>{if("Enter"===t.key&&n.value.trim()){const t=n.value.trim(),o=await e();o&&(i.addTextPost(t,o),n.value="")}})),o.addEventListener("click",(async()=>{try{const t=await e();if(!t)return;s.classList.add("active"),await c.start(),c.onTimerUpdate=t=>{r.textContent=t},c.onRecordingComplete=e=>{i.addAudioPost(e,t),s.classList.remove("active"),r.textContent="00:00"}}catch(t){alert("Не удалось получить доступ к микрофону. Пожалуйста, проверьте разрешения."),s.classList.remove("active")}})),a.addEventListener("click",(()=>{c.stop()})),d.addEventListener("click",(()=>{c.cancel(),s.classList.remove("active"),r.textContent="00:00"}))})();